#################################################
# Package Light - Nursery
#################################################

nursery_light_pack:

  # Light
  light:

    - platform: switch
      name: Детская - подсветка на окне
      entity_id: switch.blitzwolf_shp15_01_switch

    - platform: switch
      name: Детская - гирлянда на кровати
      entity_id: switch.tz3000_zloso4jk_ts011f_switch

  # Input Datetime
  input_datetime:

    sunrise_in_nursery:
      name: Время включения света в Детской
      icon: mdi:alarm
      has_date: false
      has_time: true

  # Automations
  automation:

    - alias: "Кнопка Xiaomi в Детской"
      id: b1b33068-e33a-4955-94a0-80bc3b8f61fd
      mode: queued
      max: 5
      max_exceeded: silent
      trigger:
        - platform: event
          event_type: zha_event
          event_data:
            device_ieee: "00:15:8d:00:03:3e:fd:9e"
            command: "click"
          id: "click"
        - platform: event
          event_type: zha_event
          event_data:
            device_ieee: "00:15:8d:00:03:3e:fd:9e"
            command: "hold"
          id: "hold"
      action:
        choose:
          - alias: Action Click
            conditions:
              - condition: trigger
                id: "click"
            sequence:
              choose:
                - alias: Single click
                  conditions: "{{ trigger.event.data.args.click_type == 'single' }}"
                  sequence:
                    choose:
                      - alias: Bulb unavailable
                        conditions: "{{ is_state('light.ikea_e27_detskaia', 'unavailable') }}"
                        sequence:
                          - service: light.turn_off
                            data:
                              entity_id: light.sonoff_zbmini_01_on_off
                          - delay: "00:00:01"
                          - service: light.turn_on
                            data:
                              entity_id: light.sonoff_zbmini_01_on_off
                          - wait_for_trigger:
                            - platform: state
                              entity_id: light.ikea_e27_detskaia
                              to: "on"
                            timeout: "00:00:30"
                          - service: light.turn_on
                            target:
                              entity_id: light.ikea_e27_detskaia
                            data:
                              brightness: 255
                      - alias: Relay off
                        conditions: "{{ is_state('light.sonoff_zbmini_01_on_off', 'off') }}"
                        sequence:
                          - service: light.turn_on
                            data:
                              entity_id: light.sonoff_zbmini_01_on_off
                          - wait_for_trigger:
                            - platform: state
                              entity_id: light.ikea_e27_detskaia
                              to: "on"
                            timeout: "00:00:30"
                          - service: light.turn_on
                            target:
                              entity_id: light.ikea_e27_detskaia
                            data:
                              brightness: 255
                      - alias: Relay on
                        conditions: "{{ is_state('light.sonoff_zbmini_01_on_off', 'on') }}"
                        sequence:
                          - service: light.toggle
                            data:
                              entity_id: light.ikea_e27_detskaia
                - alias: Double click
                  conditions: "{{ trigger.event.data.args.click_type == 'double' }}"
                  sequence:
                    - service: light.turn_on
                      data_template:
                        entity_id: light.ikea_e27_detskaia
                        transition: "0.5"
                        brightness: >
                          {%- if (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 3 %}
                            51
                          {% elif (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 51 %}
                            102
                          {% elif (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 102 %}
                            153
                          {% elif (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 153 %}
                            204
                          {% elif (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 204 %}
                            255
                          {% elif (state_attr('light.ikea_e27_detskaia', 'brightness') | int(0)) <= 255 %}
                            3
                          {% endif %}
                - alias: Triple click
                  conditions: "{{ trigger.event.data.args.click_type == 'triple' }}"
                  sequence:
                    - service: light.turn_on
                      data:
                        entity_id: light.ikea_e27_detskaia
                        color_temp: 270
                    - delay: "00:00:00.0500"
                    - service: light.turn_on
                      data:
                        entity_id: light.ikea_e27_detskaia
                        transition: "0.5"
                        brightness: 255
          - alias: Action Hold
            conditions:
              - condition: trigger
                id: "hold"
            sequence:
              - service: light.toggle
                data:
                  entity_id: light.detskaia_podsvetka_na_okne

    - alias: "Sunrise Lighting (Nursery)"
      id: d50bfe78-2e35-4870-a24c-71d0f6ebf969
      trigger:
        - platform: time
          at: input_datetime.sunrise_in_nursery
      condition:
        condition: and
        conditions:
          - condition: state
            entity_id: binary_sensor.workday_sensor
            state: "on"
          - condition: sun
            before: sunrise
            before_offset: "00:30:00"
          - condition: state
            entity_id: calendar.semia_alexander_borsiov_school_vacation_egor
            state: "off"
      action:
        - service: script.turn_on
          target:
            entity_id: script.sunrise_in_nursery

    - alias: "Kids must sleep at night"
      id: a2e4ec8e-926f-44bf-96fb-0029bd137f32
      initial_state: true
      trigger:
        platform: state
        entity_id: light.ikea_e27_detskaia
        to: "on"
        for:
          minutes: 2
      condition:
        condition: time
        after: "00:00"
        before: "06:30"
      action:
        - service: homeassistant.turn_off
          entity_id: light.ikea_e27_detskaia
        - service: notify.telegram_group_flat_1
          data:
            message: _{{ now().strftime("%d.%m.%Y %H:%M:%S") }}_ автоматически выключен свет в детской.

    - alias: "Кубик Aqara в Детской"
      id: 3ac0562a-feca-479d-ba2a-4bf0cc1fe5ce
      mode: queued
      max: 5
      max_exceeded: silent
      trigger:
        - platform: event
          event_type: zha_event
          event_data:
            device_ieee: "00:15:8d:00:05:29:2a:d9"
      action:
        choose:
          - alias: Rotate
            conditions: "{{ trigger.event.data.command in ('rotate_right', 'rotate_left') }}"
            sequence:
              - service: light.turn_on
                entity_id: light.ikea_e14_level_light_color_on_off
                data:
                  brightness: >-
                    {{ (state_attr('light.ikea_e14_level_light_color_on_off', 'brightness') | int(0)) +
                    (trigger.event.data.args.relative_degrees | int) }}
          - alias: Flip
            conditions: "{{ trigger.event.data.command in ('flip') }}"
            sequence:
              choose:
                - alias: Flip 90
                  conditions: "{{ (trigger.event.data.args.flip_degrees | int) == 90 }}"
                  sequence:
                    - service: light.toggle
                      entity_id: light.ikea_e14_level_light_color_on_off
                      data:
                        brightness: 255
#                - alias: Flip 180
#                  conditions: "{{ (trigger.event.data.args.flip_degrees | int) == 180 }}"
#                  sequence:
#                    - service: light.toggle
#                      entity_id: light.sonoff_1000f30a9e
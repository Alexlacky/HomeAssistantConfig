#################################################
# Package Light - Bathroom
#################################################

bathroom_light_pack:
  timer:
    bathroom_presence:
      duration: "00:05:00"

  automation:
    - alias: "Свет в Ванной"
      id: 9a24416b-82b6-4fa8-81a7-ea6c71daa727
      mode: queued
      max: 10
      max_exceeded: silent
      trigger:
        - platform: state
          entity_id: timer.bathroom_presence
          to: "idle"
          id: "timer_idle"
        - platform: state
          entity_id: binary_sensor.lumi_lumi_sensor_magnet_on_off
          id: "magnet"
        - platform: state
          entity_id: binary_sensor.trust_iaszone
          to: "on"
          id: "motion_on"
        - platform: event
          event_type: zha_event
          event_data:
            device_ieee: "00:15:8d:00:03:d1:77:62"
            command: "click"
          id: "click"
      action:
        choose:
          - alias: Timer Idle
            conditions:
              - condition: trigger
                id: "timer_idle"
            sequence:
              choose:
                - alias: Motion On
                  conditions: "{{ states('binary_sensor.trust_iaszone') == 'on' }}"
                  sequence:
                    - service: timer.start
                      target:
                        entity_id: timer.bathroom_presence
                - alias: Motion Off
                  conditions: "{{ states('binary_sensor.trust_iaszone') == 'off' }}"
                  sequence:
                    choose:
                      - alias: Motion detected > 5 min ago
                        conditions: "{{ (as_timestamp(now()) - as_timestamp(states.binary_sensor.trust_iaszone.last_changed)) > 300 }}"
                        sequence:
                          - parallel:
                              - sequence:
                                  - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
                                  - service: light.turn_off
                                    target:
                                      entity_id: light.sonoff_zbmini_04_on_off
                              - sequence:
                                  - condition: "{{ is_state('fan.bathroom_extractor', 'on') }}"
                                  - condition: "{{ is_state('binary_sensor.bathroom_high_humidity', 'off') }}"
                                  - service: fan.turn_off
                                    target:
                                      entity_id: fan.bathroom_extractor
                      - alias: Motion detected <= 5 min ago
                        conditions: "{{ (as_timestamp(now()) - as_timestamp(states.binary_sensor.trust_iaszone.last_changed)) <= 300 }}"
                        sequence:
                          - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
                          - service: light.turn_off
                            target:
                              entity_id: light.sonoff_zbmini_04_on_off
                          - delay:
                              seconds: 0.3
                          - service: light.turn_on
                            target:
                              entity_id: light.sonoff_zbmini_04_on_off
                          - wait_template: "{{ is_state('binary_sensor.trust_iaszone', 'on') }}"
                            timeout: "00:01:00"
                          - if:
                              - "{{ not wait.completed }}"
                            then:
                              - parallel:
                                  - sequence:
                                      - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
                                      - service: light.turn_off
                                        target:
                                          entity_id: light.sonoff_zbmini_04_on_off
                                  - sequence:
                                      - condition: "{{ is_state('fan.bathroom_extractor', 'on') }}"
                                      - condition: "{{ is_state('binary_sensor.bathroom_high_humidity', 'off') }}"
                                      - service: fan.turn_off
                                        target:
                                          entity_id: fan.bathroom_extractor
          - alias: Magnet
            conditions:
              - condition: trigger
                id: "magnet"
            sequence:
              choose:
                - alias: To On
                  conditions: "{{ trigger.from_state.state == 'off' and trigger.to_state.state == 'on' }}"
                  sequence:
                    - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'off') }}"
                    - service: light.turn_on
                      target:
                        entity_id: light.sonoff_zbmini_04_on_off
                    - service: timer.start
                      target:
                        entity_id: timer.bathroom_presence
                - alias: To Off
                  conditions: "{{ trigger.from_state.state == 'on' and trigger.to_state.state == 'off' }}"
                  sequence:
                    - condition: "{{ is_state('binary_sensor.trust_iaszone', 'off') }}"
                    - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
                    - service: light.turn_off
                      target:
                        entity_id: light.sonoff_zbmini_04_on_off
          - alias: Motion
            conditions:
              - condition: trigger
                id: "motion_on"
            sequence:
              - service: timer.start
                target:
                  entity_id: timer.bathroom_presence
              - parallel:
                  - sequence:
                      - condition: "{{ is_state('fan.bathroom_extractor', 'off') }}"
                      - service: fan.turn_on
                        target:
                          entity_id: fan.bathroom_extractor
                  - sequence:
                      - condition: "{{ is_state('light.sonoff_zbmini_04_on_off', 'off') }}"
                      - service: light.turn_on
                        target:
                          entity_id: light.sonoff_zbmini_04_on_off
          - alias: Button
            conditions:
              - condition: trigger
                id: "click"
            sequence:
              choose:
                - alias: Single click
                  conditions: "{{ trigger.event.data.args.click_type == 'single' }}"
                  sequence:
                    - service: light.toggle
                      data:
                        entity_id: light.sonoff_zbmini_04_on_off
                    - delay: "00:00:02"
                    - choose:
                        - alias: Light On
                          conditions: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
                          sequence:
                            - service: fan.turn_on
                              target:
                                entity_id: fan.bathroom_extractor
                        - alias: Light Off
                          conditions: "{{ is_state('light.sonoff_zbmini_04_on_off', 'off') }}"
                          sequence:
                            - condition: "{{ is_state('binary_sensor.bathroom_high_humidity', 'off') }}"
                            - service: fan.turn_off
                              target:
                                entity_id: fan.bathroom_extractor
                - alias: Double click
                  conditions: "{{ trigger.event.data.args.click_type == 'double' }}"
                  sequence:
                    - service: fan.toggle
                      target:
                        entity_id: fan.bathroom_extractor

    - alias: Ванная - вытяжка
      id: 9c4552b3-11ee-4364-bf40-2b142c5f97e6
      trigger:
        - platform: state
          entity_id: binary_sensor.bathroom_high_humidity
          to: "on"
          for:
            minutes: 3
          id: "high_humidity"
        - platform: state
          entity_id: binary_sensor.bathroom_high_humidity
          to: "off"
          for:
            minutes: 10
          id: "normal_humidity"
      action:
        choose:
          - alias: High humidity
            conditions:
              - condition: trigger
                id: "high_humidity"
            sequence:
              - condition: "{{ is_state('fan.bathroom_extractor', 'off') }}"
              - service: fan.turn_on
                target:
                  entity_id: fan.bathroom_extractor
          - alias: Normal humidity
            conditions:
              - condition: trigger
                id: "normal_humidity"
            sequence:
              - condition: "{{ is_state('fan.bathroom_extractor', 'on') }}"
              - service: fan.turn_off
                target:
                  entity_id: fan.bathroom_extractor

    #- alias: "Кнопка Xiaomi в Ванной"
    #  id: 12e5ed24-2543-4bc8-978a-434dc466d818
    #  mode: queued
    #  max: 5
    #  max_exceeded: silent
    #  trigger:
    #    - platform: event
    #      event_type: zha_event
    #      event_data:
    #        device_ieee: "00:15:8d:00:03:d1:77:62"
    #        command: "click"
    #      id: "click"
      #        - platform: event
      #          event_type: zha_event
      #          event_data:
      #            device_ieee: "00:15:8d:00:03:d1:77:62"
      #            command: "hold"
      #          id: "hold"
      #action:
      #  choose:
      #    - alias: Action Click
      #      conditions:
      #        - condition: trigger
      #          id: "click"
      #      sequence:
      #        choose:
      #          - alias: Single click
      #            conditions: "{{ trigger.event.data.args.click_type == 'single' }}"
      #            sequence:
      #              - service: light.toggle
      #                data:
      #                  entity_id: light.sonoff_zbmini_04_on_off
      #              - delay: "00:00:02"
      #              - choose:
      #                  - alias: Light On
      #                    conditions: "{{ is_state('light.sonoff_zbmini_04_on_off', 'on') }}"
      #                    sequence:
      #                      - service: fan.turn_on
      #                        target:
      #                          entity_id: fan.bathroom_extractor
      #                  - alias: Light Off
      #                    conditions: "{{ is_state('light.sonoff_zbmini_04_on_off', 'off') }}"
      #                    sequence:
      #                      - condition: "{{ is_state('binary_sensor.bathroom_high_humidity', 'off') }}"
      #                      - service: fan.turn_off
      #                        target:
      #                          entity_id: fan.bathroom_extractor
      #          - alias: Double click
      #            conditions: "{{ trigger.event.data.args.click_type == 'double' }}"
      #            sequence:
      #              - service: fan.toggle
      #                target:
      #                  entity_id: fan.bathroom_extractor
    #          - alias: Action Hold
    #            conditions:
    #              - condition: trigger
    #                id: "hold"
    #            sequence:
    #              - service: light.toggle
    #                data:
    #                  entity_id:

    #- alias: "Геркон в Ванной"
    #  id: 5742486a-8130-4315-91a6-cb25cd5e39fb
    #  mode: queued
    #  max: 5
    #  max_exceeded: silent
    #  trigger:
    #    - platform: state
    #      entity_id: binary_sensor.lumi_lumi_sensor_magnet_on_off
    #      id: "magnet"
    #  action:
    #    choose:
    #      - alias: Door Opens
    #        conditions: "{{ trigger.from_state.state == 'off' and trigger.to_state.state == 'on' }}"
    #        sequence:
    #          - choose:
    #              - alias: Light Off
    #                conditions: "{{ is_state('light.sonoff_zbmini_04_on_off', 'off') }}"
    #                sequence:
    #                  - service: light.turn_on
    #                    target:
    #                      entity_id: light.sonoff_zbmini_04_on_off
    #          - choose:
    #              - alias: Fan Off
    #                conditions: "{{ is_state('fan.bathroom_extractor','off') }}"
    #                sequence:
    #                  #                     - delay: "00:00:02"
    #                  - service: fan.turn_on
    #                    target:
    #                      entity_id: fan.bathroom_extractor

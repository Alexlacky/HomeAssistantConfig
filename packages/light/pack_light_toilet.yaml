#################################################
# Package Light - Toilet
#################################################

toilet_light_pack:

  timer:

    toilet_presence:
      duration: "00:03:00"

  automation:

    - alias: "Кнопка Xiaomi в Туалете"
      id: fd70c07a-4a17-46ca-b91b-aa15c47c8ae4
      mode: queued
      max: 5
      max_exceeded: silent
      trigger:
        - platform: event
          event_type: zha_event
          event_data:
            device_ieee: "00:15:8d:00:03:d1:5d:00"
            command: "click"
          id: "click"
#        - platform: event
#          event_type: zha_event
#          event_data:
#            device_ieee: "00:15:8d:00:03:d1:5d:00"
#            command: "hold"
#          id: "hold"
      action:
        choose:
          - alias: Action Click
            conditions:
              - condition: trigger
                id: "click"
            sequence:
              choose:
                - alias: Single click
                  conditions: "{{ trigger.event.data.args.click_type == 'single' }}"
                  sequence:
                    - service: light.toggle
                      data:
                        entity_id: light.sonoff_zbmini_03_on_off
                - alias: Double click
                  conditions: "{{ trigger.event.data.args.click_type == 'double' }}"
                  sequence:
                    - service: fan.toggle
                      data:
                        entity_id: fan.toilet_extractor
#          - alias: Action Hold
#            conditions:
#              - condition: trigger
#                id: "hold"
#            sequence:
#              - service: light.toggle
#                data:
#                  entity_id:

    - alias: "ДД Trust в Туалете"
      id: 203aa3ab-9d3c-40e9-ae3e-e77ebd0c88c2
      mode: queued
      max: 5
      max_exceeded: silent
      trigger:
        - platform: state
          entity_id: binary_sensor.adurolight_vms_adurolight_f604cd01_ias_zone
          id: "motion"
        - platform: state
          entity_id: timer.toilet_presence
          id: "timer"
      action:
        choose:
          - alias: Motion
            conditions:
              - condition: trigger
                id: "motion"
            sequence:
              choose:
                - alias: To On
                  conditions: "{{ trigger.to_state.state == 'on' }}"
                  sequence:
                    - service: timer.start
                      target:
                        entity_id: timer.toilet_presence
                    - service: fan.turn_on
                      target:
                        entity_id: fan.toilet_extractor
#                - alias: To Off
#                  conditions: "{{ trigger.to_state.state == 'off' }}"
#                  sequence:
#                    - service: fan.turn_off
#                      target:
#                        entity_id: fan.toilet_extractor
          - alias: Timer
            conditions:
              - condition: trigger
                id: "timer"
            sequence:
              choose:
                conditions: "{{ trigger.to_state.state == 'idle' }}"
                sequence:
                  - condition: state
                    entity_id: binary_sensor.adurolight_vms_adurolight_f604cd01_ias_zone
                    state: "off"
                  - service: fan.turn_off
                    target:
                      entity_id: fan.toilet_extractor

    - alias: "Геркон в Туалете"
      id: 0cd5448c-757e-49f8-b9ae-7006dab3d842
      mode: queued
      max: 5
      max_exceeded: silent
      trigger:
        - platform: state
          entity_id: binary_sensor.lumi_lumi_sensor_magnet_9bef9603_on_off
          id: "magnet"
      action:
        choose:
          - alias: Door Opens
            conditions: "{{ trigger.from_state.state == 'off' and trigger.to_state.state == 'on' }}"
            sequence:
              choose:
                - alias: Light Off
                  conditions: "{{ is_state('light.sonoff_zbmini_03_on_off', 'off') }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.sonoff_zbmini_03_on_off
#                - alias: Fan Off
#                  conditions: "{{ is_state('fan.tolilet_extractor','off') }}"
#                  sequence:
#                    - delay: "00:00:02"
#                    - service: fan.turn_on
#                      target:
#                        entity_id: fan.toilet_extractor
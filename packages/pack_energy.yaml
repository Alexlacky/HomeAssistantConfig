#################################################
# Energy Consumption Monitoring
#################################################

energy_pack:
  # Input Numbers
  input_number:
    apartment_enegry_cost_current:
      name: Стоимость кВт⋅ч текущая
      icon: mdi:cash
      unit_of_measurement: "RUB/kWh"
      min: 0.01
      max: 100
      step: 0.01
      mode: box

  # Input Datetimes
  input_datetime:
    apartment_enegry_start_time_peak_1:
      name: Начало тарифа пик 1
      icon: mdi:timeline-clock-outline
      has_date: false
      has_time: true
    apartment_enegry_start_time_peak_2:
      name: Начало тарифа пик 2
      icon: mdi:timeline-clock-outline
      has_date: false
      has_time: true
    apartment_enegry_start_time_halfpeak_1:
      name: Начало тарифа полупик 1
      icon: mdi:timeline-clock-outline
      has_date: false
      has_time: true
    apartment_enegry_start_time_halfpeak_2:
      name: Начало тарифа полупик 2
      icon: mdi:timeline-clock-outline
      has_date: false
      has_time: true
    apartment_enegry_start_time_night:
      name: Начало тарифа ночь
      icon: mdi:timeline-clock-outline
      has_date: false
      has_time: true

  # Sensors
  sensor:
    - platform: template
      sensors:
        # RUB per kWh
        apartment_enegry_cost_peak:
          friendly_name: "Стоимость кВт⋅ч пик ({{ state_attr('sensor.mes_07762_153_47_account','zone_t1_description') }})"
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% set t1_tariff = state_attr('sensor.mes_07762_153_47_account', 'zone_t1_tariff') | float(default=-1) %}
            {% if t1_tariff != -1 %}
              {{ t1_tariff }}
            {% else %}
              {{ 7.4 }}
            {% endif %}
        apartment_enegry_cost_halfpeak:
          friendly_name: "Стоимость кВт⋅ч полупик ({{ state_attr('sensor.mes_07762_153_47_account','zone_t3_description') }})"
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% set t3_tariff = state_attr('sensor.mes_07762_153_47_account', 'zone_t3_tariff') | float(default=-1) %}
            {% if t3_tariff != -1 %}
              {{ t3_tariff }}
            {% else %}
              {{ 6.17 }}
            {% endif %}
        apartment_enegry_cost_night:
          friendly_name: "Стоимость кВт⋅ч ночь ({{ state_attr('sensor.mes_07762_153_47_account','zone_t2_description') }})"
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% set t2_tariff = state_attr('sensor.mes_07762_153_47_account', 'zone_t2_tariff') | float(default=-1) %}
            {% if t2_tariff != -1 %}
              {{ t2_tariff }}
            {% else %}
              {{ 2.69 }}
            {% endif %}

        # Main Power Meter
        energy_flat_main_power:
          device_class: power
          unit_of_measurement: "W"
          icon_template: mdi:flash
          value_template: "{{ states('sensor.sonoff_1001322978_power') }}"
        energy_flat_main_current:
          device_class: current
          unit_of_measurement: "A"
          icon_template: mdi:current-ac
          value_template: "{{ states('sensor.sonoff_1001322978_current') }}"
        energy_flat_main_voltage:
          device_class: voltage
          unit_of_measurement: "V"
          icon_template: mdi:sine-wave
          value_template: "{{ states('sensor.sonoff_1001322978_voltage') }}"

        # Individual monthly\daily costs
        # Main
        energy_cost_main_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.switch_main_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.switch_main_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.switch_main_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_main_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.switch_main_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.switch_main_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.switch_main_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_main_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_main_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_main_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.switch_main_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.switch_main_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.switch_main_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Server room
        energy_cost_server_room_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_server_room_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_server_room_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_server_room_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_server_room_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_server_room_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_server_room_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_server_room_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_server_room_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_server_room_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_server_room_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_server_room_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_server_room_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_server_room_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Washing machine
        energy_cost_washmachine_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_washmachine_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_washmachine_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_washmachine_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_washmachine_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_washmachine_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_washmachine_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_washmachine_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_washmachine_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_washmachine_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_washmachine_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_washmachine_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_washmachine_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_washmachine_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Dryer machine
        energy_cost_dryer_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_dryer_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_dryer_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_dryer_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_dryer_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_dryer_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_dryer_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_dryer_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_dryer_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_dryer_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_dryer_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_dryer_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_dryer_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_dryer_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Dishwasher
        energy_cost_dishwasher_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_kitchen_dishwasher_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_kitchen_dishwasher_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_kitchen_dishwasher_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_dishwasher_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_dishwasher_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_dishwasher_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_dishwasher_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_dishwasher_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_dishwasher_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_dishwasher_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_dishwasher_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_dishwasher_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_dishwasher_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Water boiler
        energy_cost_water_boiler_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_water_boiler_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_water_boiler_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_water_boiler_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_water_boiler_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_water_boiler_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_water_boiler_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_water_boiler_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_water_boiler_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_water_boiler_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_water_boiler_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_water_boiler_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_water_boiler_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_water_boiler_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Fridge
        energy_cost_fridge_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_kitchen_fridge_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_kitchen_fridge_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_kitchen_fridge_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_fridge_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_fridge_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_fridge_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_fridge_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_fridge_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_fridge_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_fridge_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_fridge_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_fridge_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_fridge_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

        # Oven
        energy_cost_oven_monthly:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((states('sensor.socket_kitchen_oven_energy_monthly_peak') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((states('sensor.socket_kitchen_oven_energy_monthly_halfpeak') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((states('sensor.socket_kitchen_oven_energy_monthly_night') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_oven_monthly_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_oven_energy_monthly_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_oven_energy_monthly_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_oven_energy_monthly_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}
        energy_cost_oven_daily_avg:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {% 
              set days =
              31 if now().month-1 in (1,3,5,7,8,10,12) else 
              30 if now().month-1 in (4,6,9,11) else 
              29 if now().month-1 == 2 and now().year % 4 == 0 else 28
            %}
            {{ ((states('sensor.energy_cost_oven_monthly_prev') | float(0)) / ( days | float(0) )) | round(2) }}
        energy_cost_oven_daily_prev:
          device_class: monetary
          unit_of_measurement: "RUB"
          icon_template: mdi:cash
          value_template: >
            {{
              (((state_attr('sensor.socket_kitchen_oven_energy_daily_peak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_peak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_oven_energy_daily_halfpeak', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_halfpeak') | float(0)))+
              ((state_attr('sensor.socket_kitchen_oven_energy_daily_night', 'last_period') | float(0)) * (states('sensor.apartment_enegry_cost_night') | float(0)))) | round(2)
            }}

    # kWh from W
    - platform: integration
      source: sensor.energy_flat_main_power
      name: energy_flat_main_usage
      unit_prefix: k
      round: 2

  # Utility Meters
  utility_meter:
    # For Main
    switch_main_energy_daily:
      name: Main Daily Energy
      source: sensor.energy_flat_main_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    switch_main_energy_daily_sum:
      name: Main Daily Energy Total
      source: sensor.energy_flat_main_usage
      cycle: daily
      tariffs:
        - total
    switch_main_energy_monthly:
      name: Main Monthly Energy
      source: sensor.energy_flat_main_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    switch_main_energy_monthly_sum:
      name: Main Monthly Energy Total
      source: sensor.energy_flat_main_usage
      cycle: monthly
      tariffs:
        - total

    # For Server Room
    socket_server_room_energy_daily:
      name: Server Room Daily Energy
      source: sensor.gosund_sp111_03_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_server_room_energy_monthly:
      name: Server Room Monthly Energy
      source: sensor.gosund_sp111_03_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_server_room_energy_monthly_sum:
      name: Server Room Monthly Energy Total
      source: sensor.gosund_sp111_03_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Fridge
    socket_kitchen_fridge_energy_daily:
      name: Kitchen Fridge Daily Energy
      source: sensor.gosund_sp111_04_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_fridge_energy_monthly:
      name: Kitchen Fridge Monthly Energy
      source: sensor.gosund_sp111_04_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_fridge_energy_monthly_sum:
      name: Kitchen Fridge Monthly Energy Total
      source: sensor.gosund_sp111_04_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Oven
    socket_kitchen_oven_energy_daily:
      name: Kitchen Oven Daily Energy
      source: sensor.gosund_sp111_10_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_oven_energy_monthly:
      name: Kitchen Oven Monthly Energy
      source: sensor.gosund_sp111_10_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_oven_energy_monthly_sum:
      name: Kitchen Oven Monthly Energy Total
      source: sensor.gosund_sp111_10_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Electric Kettle
    socket_kitchen_kettle_energy_daily:
      name: Kitchen Electric Kettle Daily Energy
      source: sensor.gosund_sp111_05_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_kettle_energy_monthly:
      name: Kitchen Electric Kettle Monthly Energy
      source: sensor.gosund_sp111_05_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_kettle_energy_monthly_sum:
      name: Kitchen Electric Kettle Monthly Energy Total
      source: sensor.gosund_sp111_05_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Dishwasher
    socket_kitchen_dishwasher_energy_daily:
      name: Kitchen Dishwasher Daily Energy
      source: sensor.gosund_sp111_06_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_dishwasher_energy_monthly:
      name: Kitchen Dishwasher Monthly Energy
      source: sensor.gosund_sp111_06_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_kitchen_dishwasher_energy_monthly_sum:
      name: Kitchen Dishwasher Monthly Energy Total
      source: sensor.gosund_sp111_06_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Washing Machine
    socket_washmachine_energy_daily:
      name: Washmachine Daily Energy
      source: sensor.tplink_smartplug_02_today_s_consumption
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_washmachine_energy_monthly:
      name: Washmachine Monthly Energy
      source: sensor.tplink_smartplug_02_today_s_consumption
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_washmachine_energy_monthly_sum:
      name: Washmachine Monthly Energy Total
      source: sensor.tplink_smartplug_02_today_s_consumption
      cycle: monthly
      tariffs:
        - total

    # For Dryer Machine
    socket_dryer_energy_daily:
      name: Dryer Machine Daily Energy
      source: sensor.gosund_sp111_09_todays_usage
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_dryer_energy_monthly:
      name: Dryer Machine Monthly Energy
      source: sensor.gosund_sp111_09_todays_usage
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_dryer_energy_monthly_sum:
      name: Dryer Machine Monthly Energy Total
      source: sensor.gosund_sp111_09_todays_usage
      cycle: monthly
      tariffs:
        - total

    # For Water Boiler
    socket_water_boiler_energy_daily:
      name: Water Boiler Daily Energy
      source: sensor.tplink_smartplug_01_today_s_consumption
      cycle: daily
      tariffs:
        - peak
        - halfpeak
        - night
    socket_water_boiler_energy_monthly:
      name: Water Boiler Monthly Energy
      source: sensor.tplink_smartplug_01_today_s_consumption
      cycle: monthly
      tariffs:
        - peak
        - halfpeak
        - night
    socket_water_boiler_energy_monthly_sum:
      name: Water Boiler Monthly Energy Total
      source: sensor.tplink_smartplug_01_today_s_consumption
      cycle: monthly
      tariffs:
        - total

  # Groups
  group:
    all_energy_utility_meters:
      - select.switch_main_energy_daily
      - select.switch_main_energy_monthly
      - select.socket_server_room_energy_daily
      - select.socket_server_room_energy_monthly
      - select.socket_kitchen_fridge_energy_daily
      - select.socket_kitchen_fridge_energy_monthly
      - select.socket_kitchen_oven_energy_daily
      - select.socket_kitchen_oven_energy_monthly
      - select.socket_kitchen_kettle_energy_daily
      - select.socket_kitchen_kettle_energy_monthly
      - select.socket_kitchen_dishwasher_energy_daily
      - select.socket_kitchen_dishwasher_energy_monthly
      - select.socket_washmachine_energy_daily
      - select.socket_washmachine_energy_monthly
      - select.socket_dryer_energy_daily
      - select.socket_dryer_energy_monthly
      - select.socket_water_boiler_energy_daily
      - select.socket_water_boiler_energy_monthly

  # Automations
  automation:
    # --- Set energy tariffs start time ---
    - alias: Energy - Apartment - Set Start Time of Tariffs
      id: 7dc9e636-2951-407e-b50f-31d6b0b22961
      trigger:
        - platform: time_pattern
          hours: "/1"
          minutes: "15"
      condition: "{{ not states('sensor.mes_07762_153_47_account') in ('unavailable') }}"
      action:
        # Set Peak Time
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.apartment_enegry_start_time_peak_1
          data:
            time: >
              {% set time = (state_attr('sensor.mes_07762_153_47_account', 'zone_t1_description') | regex_findall_index('^(\d+-\d+)')).replace('-',':') -%}
              {% if (time.split(':')[0] | int) < 10 %}0{{ time }}:00{% else %}{{ time }}:00{% endif %}
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.apartment_enegry_start_time_peak_2
          data:
            time: >
              {% set time = (state_attr('sensor.mes_07762_153_47_account', 'zone_t1_description') | regex_findall_index(',.(\d+-\d+)')).replace('-',':') -%}
              {% if (time.split(':')[0] | int) < 10 -%}0{{ time }}:00{%- else -%}{{ time }}:00{% endif %}
        # Set Halfpeak Time
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.apartment_enegry_start_time_halfpeak_1
          data:
            time: >
              {% set time = (state_attr('sensor.mes_07762_153_47_account', 'zone_t3_description') | regex_findall_index('^(\d+-\d+)')).replace('-',':') -%}
              {% if (time.split(':')[0] | int) < 10 %}0{{ time }}:00{% else %}{{ time }}:00{% endif %}
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.apartment_enegry_start_time_halfpeak_2
          data:
            time: >
              {% set time = (state_attr('sensor.mes_07762_153_47_account', 'zone_t3_description') | regex_findall_index(',.(\d+-\d+)')).replace('-',':') -%}
              {% if (time.split(':')[0] | int) < 10 -%}0{{ time }}:00{%- else -%}{{ time }}:00{% endif %}
        # Set Night Time
        - service: input_datetime.set_datetime
          target:
            entity_id: input_datetime.apartment_enegry_start_time_night
          data:
            time: >
              {% set time = (state_attr('sensor.mes_07762_153_47_account', 'zone_t2_description') | regex_findall_index('^(\d+-\d+)')).replace('-',':') -%}
              {% if (time.split(':')[0] | int) < 10 %}0{{ time }}:00{% else %}{{ time }}:00{% endif %}

    # --- --- --- --- --- --- --- --- --- -

    # --- Set current energy tariff ---
    - alias: Energy - Apartment - Set Current Tariff
      id: 0266f51b-5a79-4c13-b925-f50952cc49ed
      trigger:
        - platform: time
          at:
            - input_datetime.apartment_enegry_start_time_peak_1
            - input_datetime.apartment_enegry_start_time_peak_2
          id: "peak"
        - platform: time
          at:
            - input_datetime.apartment_enegry_start_time_halfpeak_1
            - input_datetime.apartment_enegry_start_time_halfpeak_2
          id: "halfpeak"
        - platform: time
          at: input_datetime.apartment_enegry_start_time_night
          id: "night"
      action:
        choose:
          # Set Peak Tariff
          - alias: Set Peak Tariff
            conditions:
              - condition: trigger
                id: "peak"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.apartment_enegry_cost_current
                data:
                  value: "{{ states('sensor.apartment_enegry_cost_peak') | float(0) }}"
              - service: select.select_option
                target:
                  entity_id: group.all_energy_utility_meters
                data:
                  option: peak
          # Set Halfpeak Tariff
          - alias: Set Halfpeak Tariff
            conditions:
              - condition: trigger
                id: "halfpeak"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.apartment_enegry_cost_current
                data:
                  value: "{{ states('sensor.apartment_enegry_cost_halfpeak') | float(0) }}"
              - service: select.select_option
                target:
                  entity_id: group.all_energy_utility_meters
                data:
                  option: halfpeak
          # Set Night Tariff
          - alias: Set Night Tariff
            conditions:
              - condition: trigger
                id: "night"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.apartment_enegry_cost_current
                data:
                  value: "{{ states('sensor.apartment_enegry_cost_night') | float(0) }}"
              - service: select.select_option
                target:
                  entity_id: group.all_energy_utility_meters
                data:
                  option: night
